library(dplyr)
# Insert database connection information here #
library(odbc)
library(getPass)

pacfin <- DBI::dbConnect(odbc::odbc(),
                         host   = "pacfindb.psmfc.org",
                         UID    = getPass('pacfin username'),
                         PWD    = getPass('pacfin password'),
                         dsn    = 'pacfin',
                         port   = 2045)

preventingprintingtoconsole <- dbSendQuery(pacfin, "alter session set current_schema=PACFIN_MARTS")
species_speciesgrps <- dbGetQuery(pacfin, "select pacfin_species_code,
                                      agency_code,
                                      management_group_code,
                         -- Formatting species groups
                                      CASE WHEN
                                      inpfc_area_type_code = 'PG' THEN 'PUGET SOUND FISHERIES'
                                      WHEN pacfin_species_common_name like '%TUNA%' OR pacfin_species_common_name = 'ALBACORE' 
                                        THEN 'TUNA'
                                        WHEN management_group_code = 'GRND' THEN 
                                         CASE WHEN IS_IFQ_LANDING = 'T' THEN 
                                            CASE WHEN pacfin_species_code = 'PWHT' THEN 'WHITING'
                                            WHEN PACFIN_GEAR_CODE = 'MDT' THEN 'MIDWATER'
                                            WHEN DAHL_GROUNDFISH_CODE = '14' THEN 'MIDWATER'
                                              ELSE 'NON-WHITING GROUNDFISH IFQ' END
                                         WHEN DAHL_GROUNDFISH_CODE IN ('05','06') THEN 'NEARSHORE GROUNDFISH'
                                         WHEN DAHL_GROUNDFISH_CODE IN ('07','08','09','10','20') THEN 'OFFSHORE GROUNDFISH'
                                         WHEN DAHL_GROUNDFISH_CODE IN ('11','12','13','14') THEN 'OTHER'
                                         ELSE 'NON-WHITING GROUNDFISH NON-IFQ' END 
                                        WHEN 
                                        management_group_code = 'CPEL'
                                        THEN CASE WHEN 
                                                pacfin_species_code = 'PSDN' THEN 'SARDINE'
                                                WHEN
                                                pacfin_species_code = 'NANC' THEN 'ANCHOVY'
                                                WHEN
                                                pacfin_species_code = 'MSQD' THEN 'MARKET SQUID'
                                                WHEN
                                                pacfin_species_code IN ('CMCK','JMCK','UMCK') THEN 'OTHER COASTAL PELAGIC'
                                                ELSE 'OTHER'
                                                END 
                                        WHEN
                                        management_group_code = 'CRAB'
                                        THEN CASE WHEN 
                                        pacfin_species_code = 'DCRB' THEN 'DUNGENESS CRAB'
                                        ELSE 'OTHER CRAB'
                                        END
                           -- CDK - Changind CPEL to Coastal Pelagic from Other and included only species specified by Steve Stohs as CPS
                                        WHEN management_group_code = 'HMSP'             
                                        THEN 'OTHER'
                                        WHEN management_group_code = 'SAMN'             
                                        THEN 'SALMON'
                                        WHEN management_group_code = 'SRMP'             
                                        THEN 'SHRIMP'
                                        WHEN management_group_code = 'SHLL'             
                                        THEN 'SHELLFISH'
                                        WHEN nvl(management_group_code,'OTHR') = 'OTHR' 
                                        THEN 'OTHER'
                                        ELSE 'CHECK'
                                        END species_group
                                      FROM comprehensive_ft
                                          WHERE
                                          participation_group_code in ('C')
                            -- Excluding ETIX, only want hard data --
                                         -- AND is_etix_data = 'F'
                            -- Excluding Roe as in original script --
                                          AND condition_code != 'E'
                                          AND council_code IN ('P','*')
                                          AND inpfc_area_type_code NOT IN ('CT','VC','GS')
                                          AND landing_year >= 2014 
                                          AND exvessel_revenue > 0
                            -- Excluding tribal -- 
                                          AND FLEET_CODE <> 'TI'
                            -- EXCLUDE SHELLFISH --
                                          AND management_group_code != 'SHLL'
                                     GROUP BY
                                        agency_code,
                                        pacfin_species_code,
                                        management_group_code,
                                        CASE WHEN 
                                        inpfc_area_type_code = 'PG' THEN 'PUGET SOUND FISHERIES'
                                      WHEN pacfin_species_common_name like '%TUNA%' OR pacfin_species_common_name = 'ALBACORE' 
                                        THEN 'TUNA'
                                        WHEN management_group_code = 'GRND' THEN 
                                         CASE WHEN IS_IFQ_LANDING = 'T' THEN 
                                            CASE WHEN pacfin_species_code = 'PWHT' THEN 'WHITING'
                                            WHEN PACFIN_GEAR_CODE = 'MDT' THEN 'MIDWATER'
                                            WHEN DAHL_GROUNDFISH_CODE = '14' THEN 'MIDWATER'
                                              ELSE 'NON-WHITING GROUNDFISH IFQ' END
                                         WHEN DAHL_GROUNDFISH_CODE IN ('05','06') THEN 'NEARSHORE GROUNDFISH'
                                         WHEN DAHL_GROUNDFISH_CODE IN ('07','08','09','10','20') THEN 'OFFSHORE GROUNDFISH'
                                         WHEN DAHL_GROUNDFISH_CODE IN ('11','12','13','14') THEN 'OTHER'
                                         ELSE 'NON-WHITING GROUNDFISH NON-IFQ' END 
                                         WHEN 
                                        management_group_code = 'CPEL'
                                        THEN CASE WHEN 
                                                pacfin_species_code = 'PSDN' THEN 'SARDINE'
                                                WHEN
                                                pacfin_species_code = 'NANC' THEN 'ANCHOVY'
                                                WHEN
                                                pacfin_species_code = 'MSQD' THEN 'MARKET SQUID'
                                                WHEN
                                                pacfin_species_code IN ('CMCK','JMCK','UMCK') THEN 'OTHER COASTAL PELAGIC'
                                                ELSE 'OTHER'
                                                END 
                                        WHEN
                                        management_group_code = 'CRAB'
                                        THEN CASE WHEN 
                                        pacfin_species_code = 'DCRB' THEN 'DUNGENESS CRAB'
                                        ELSE 'OTHER CRAB'
                                        END
                           -- CDK - Changind CPEL to Coastal Pelagic from Other and included only species specified by Steve Stohs as CPS
                                        WHEN management_group_code = 'HMSP'             
                                        THEN 'OTHER'
                                        WHEN management_group_code = 'SAMN'             
                                        THEN 'SALMON'
                                        WHEN management_group_code = 'SRMP'             
                                        THEN 'SHRIMP'
                                        WHEN management_group_code = 'SHLL'             
                                        THEN 'SHELLFISH'
                                        WHEN nvl(management_group_code,'OTHR') = 'OTHR' 
                                        THEN 'OTHER'
                                        ELSE 'CHECK'
                                        END")

source("C:/Program Files/R/connectioninfoROracle.R")
dbSendQuery(framdw, "alter session set current_schema = FRAM_ANALYSIS")
species_names <- dbGetQuery(framdw, "select spid, cname from pacfin_species") %>%
  rename(PACFIN_SPECIES_CODE = SPID)

wa_or_othr <- c('OTHER CRAB', 'ANCHOVY', 'SARDINE', 'OTHER COASTAL PELAGIC')
species_speciesgrp_names <- full_join(species_speciesgrps, species_names) %>%
  mutate(SPECIES_GROUP = case_when(
    AGENCY_CODE %in% c('W', 'O') & SPECIES_GROUP %in% wa_or_othr ~ 'OTHER',
    T ~ SPECIES_GROUP)) 
species_nongrnd <- filter(species_speciesgrp_names, MANAGEMENT_GROUP_CODE != 'GRND' & SPECIES_GROUP != 'PUGET SOUND FISHERIES')
species_nogrnd_table <- species_nongrnd %>%
  select(CNAME, AGENCY_CODE, SPECIES_GROUP) %>%
  filter(!is.na(CNAME)) %>%
  dcast(CNAME ~ AGENCY_CODE, value.var = 'SPECIES_GROUP')
write.csv(species_nogrnd_table, "species_list.csv")

species_grnd <- filter(species_speciesgrp_names, MANAGEMENT_GROUP_CODE == 'GRND')
species_puget <- filter(species_speciesgrp_names, SPECIES_GROUP == 'PUGET SOUND FISHERIES')
