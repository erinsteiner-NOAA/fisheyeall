# testing

# This script pulls data and formats the dataframe for use in the app #
library(dplyr)
library(reshape2)
library(lubridate)
library(EDCReport)
library(tidyr)
#devtools::install_github("sboysel/fredr")
library(fredr)

source("confTreat.R")
source("helperfns.R")
source("dataprep_fn.R")


# pull in the date stamp from the datapull file
datpull_date <- as.Date('2020-07-29')

# load the deflators
gdp_defl <- readRDS(paste0("R:/Confidential/FISHEyE/data/landings_tracker/defl", datpull_date, ".RDS"))

# pull in data from datapull.R
comp_dat_raw_load <- readRDS(paste0('R:/Confidential/FISHEyE/data/landings_tracker/comp_dat_raw', datpull_date, '.RDS'))

old <- readRDS("R:/Confidential/FISHEyE/data/landings_tracker/comp_dat_covidapp2020-07-29.RDS") %>%
  select(Year, Metric, Statistic, LANDING_MONTH2, Interval, Species, Cumulative, State, N_buy, N_vss, Value, Type) %>%
  mutate(LANDING_MONTH = as.numeric(LANDING_MONTH2)) %>%
  subset(
    # I don't think we need this combo?
    !(Species == 'Whiting: Shorebased' & State == 'At-sea') &
    # We don't show these combos in landings tracker
    !(Cumulative == 'Y' & Statistic %in% c('Mean', 'Median')) &
    # all zeroes
    !(State == 'Oregon' & Year %in% c(2015, 2017) & Species == 'Market squid') &
    # I moved landing week 53 into week 52 for simplicity
    !(LANDING_MONTH %in% c(52, 53))
    ) %>%
  # I think there were duplicate in the numbers of vessels and numbers of buyers?
  distinct()


new <- dataprep_fn(comp_dat_raw_load)
new <-  rename(app_data_fmt_dates, LANDING_MONTH = Dates)

summ_new <- group_by(new,Year, LANDING_MONTH, 
  Metric, 
  Statistic, 
  Interval, Species, 
  Cumulative, State
  ) %>%
  summarise(valuenew = sum(Value))

summ_old <- group_by(old, Year, LANDING_MONTH, 
  Metric, 
  Statistic, 
  Interval, Species, 
  Cumulative, State
  ) %>%
  summarise(valueold = sum(Value))

test <- full_join(summ_old, summ_new)

tt <- mutate(test, match = case_when(
  is.na(valueold) & is.na(valuenew) ~ 'match',
  is.na(valueold) & valuenew == 0 ~ 'match',
  is.na(valueold) & valuenew > 0 ~ 'orig:suppr, new:reveal',
  is.na(valuenew) & valueold == 0 ~ 'match',
  is.na(valuenew) & valueold > 0 ~ 'orig:reveal, new:suppr',
  near(valueold, valuenew, tol = .Machine$double.eps) ~ 'match',
  T ~ 'miss')) %>%
  subset(Year != '2020') %>%
  mutate(match = factor(match, levels = c('match', 'miss', 'orig:suppr, new:reveal', 'orig:reveal, new:suppr')))

subset(tt, Cumulative == 'N' & Metric == 'Laned weight (mt)) %>%
group_by(match, State, Year) %>%
  dcast(State + Year~ match, value.var = 'Year', length)

subset(tt, State == 'At-sea') %>% subset(match == 'miss') %>%
  group_by(match, Year) %>%
  reshape2::dcast(Year ~ match, value.var = 'Year', length)

# save the raw data with a date stamp for "completeness monitoring"
saveRDS(app_data, paste0("R:/Confidential/FISHEyE/data/landings_tracker/comp_dat_covidapp", Sys.Date(), ".RDS"))

# Notes about revised data prep:

# Remove category Species = 'Whiting: Shorebased' & State == 'At-sea' (we already have the data in all, so I don't think we need it?)