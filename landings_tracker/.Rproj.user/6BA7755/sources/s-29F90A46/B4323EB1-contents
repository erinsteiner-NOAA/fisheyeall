library(dplyr)
library(data.table)
source("helperfns.R")
# Formatting data frame for Marie #####
comp_dat_covid_app <- readRDS("comp_dat_covidapp.RDS") %>%
  data.table()
setkey(comp_dat_covid_app, State, Species)
# split up the month and other filters befor joining to reduce size of df 
addlfilters <- readRDS("addlfilters.RDS")
othr_filter <- select(addlfilters, -c(month_prop, select_month)) %>% distinct() %>%
  data.table()
setkey(othr_filter, State, Species)

# weird error message, so didn't use this dataframe
data <- othr_filter[comp_dat_covid_app, on = c('State','Species')] %>%
  data.table()

# If is.na(Value) then confidential

state_proportion <- othr_filter %>%
  distinct(State, Species, state_prop1)

# number of vessels by year - baseline median
comp_dat_all <- readRDS("comp_dat_all.RDS")

participants <- comp_dat_all %>%
  filter(!is.na(VESSEL_NUM)) %>%
  group_by(YEAR, SPECIES_GROUP, AGENCY_CODE) %>%
  summarise(num_vss = length(unique(VESSEL_NUM))) %>%
  filter(YEAR != 2020) %>%
  group_by(SPECIES_GROUP, AGENCY_CODE) %>%
  summarise(N = median(num_vss)) %>%
  ungroup() %>%
  rename(Species = SPECIES_GROUP,
         State = AGENCY_CODE) %>%
  mutate(Species = convert_sp(Species),
         Species = as.factor(Species),
         State = convert_state(State))

# Percent change in cumulative ex-vessel revenue & landed weight by fishery comparing 2020 to 2015-2019 median
perchange_byfishery <- comp_dat_covid_app %>%
  filter(Cumulative == 'Y', Year %in% c('2020', 'Baseline'), grepl('05', LANDING_MONTH), Interval == 'Monthly', Statistic == 'Total', State != 'At-sea') %>%
  mutate(Year = ifelse(Year == '2020', 'current', 'Baseline')) %>%
  reshape2::dcast(State + Species + Metric  ~ Year,
                  value.var = "Value") %>%
  mutate(percchange = round((current - Baseline)/Baseline*100,0)) %>%
  merge(state_proportion, by = c('State', 'Species')) %>%
  merge(participants, by = c('State', 'Species'))

# The end result is to provide a bullet like the following for each fishery/state:
# "The Oregon Dungeness crab fishery contributes to approximately 30% of state-wide fisheries revenue 
# and around 340 vessels participate each year (based on 2015-2019 5-year median values). 
# Dungeness crab volume and ex-vessel revenue in Oregon were slightly higher than the 5-year median (2015-2019). 
# Landed weight was 3% higher and ex-vessel revenue was 8% higher than the median value." 